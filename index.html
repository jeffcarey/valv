<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale.v1.min.js"></script>
    <script src="https://d3js.org/d3-random.v1.min.js"></script>
    <style>
    body {
        margin: 0;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left:0;
        background-color: #000;
    }

    text {
        fill: white;
        font-family: sans-serif;
        font-size: 18pt;
    }
    text.smallfont {
        font-size: 12pt;
    }

    .bodytext {
        position: absolute;
        text-align: justify;
        width: 400px;
        color: white;
        font-family: sans-serif;
        pointer-events: none;
    }

    </style>
</head>

<body>
<script>

d3.selection.prototype.translate = function(a, b) {
  return arguments.length === 1 ?
        this.attr("transform", "translate(" + a + ")")
      : this.attr("transform", "translate(" + a + "," + b + ")");
};

var width = window.innerWidth;
var height = window.innerHeight;

var dom = {};

var colors = d3.schemeCategory10;

dom.introtext = d3.select("body").append("div")
    .attr("class", "bodytext")
    .style("margin-left", width/2-200 + "px")
    .style("margin-top", height/4 + "px")
    .style("opacity", 1)
dom.introtext.selectAll("p")
    .data(["The completeness, and therefore utility, of Wikipedia depends largely on the language that you speak.",
          "The Wikipedia community has selected one thousand articles every Wikipedia should have. Obviously, this list has the biases of the educated and Anglophonic people who formulated it, and someone living in dire poverty would probably pick water filtration over quantum mechanics. Neverless, these articles provide a broad sample of important topics.",
          "In this visualization, we will represent the length of the articles (a naive proxy for quality) as colored boxes. The brighter the box, the more complete the article.",
          "Mouse over the box to see which article it represents. Click to view the article.",
          "Use the spacebar or left/right arrows to progress through different languages, and their Wikipedias."
    ])
    .enter().append("p")
    .text(function(d){return d})

dom.aftertext = d3.select("body").append("div")
    .attr("class", "bodytext")
    .style("margin-left", width/2-200 + "px")
    .style("margin-top", height/4 + "px")
    .style("opacity", 0)
dom.aftertext.selectAll("p")
    .data(["The political and economic divides we face today, in the United States and globally, no longer stem from differences of opion. They arise from differences of fact.",
          "Access to information has always torn down established oligarchies and given power and freedom to the masses. Now, more than ever, the ability to educate the world is our best hope of coexisting as a global civilization."
    ])
    .enter().append("p")
    .text(function(d){return d})

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

var introParticles =
    particleSystem({g: svg.append("g"), intense: true, running: true});

var afterParticles =
    particleSystem({g: svg.append("g"), intense: false, running: false});

dom.treemap = svg.append("g")
    .translate(width/2-400, height/2-200)

dom.title = svg.append("text")
    .translate(width/2, height/6)
    .attr("text-anchor", "middle")

dom.nspeakers = svg.append("text")
    .attr("class", "smallfont")
    .translate(width/2, height/6 + 20)
    .attr("text-anchor", "middle")

dom.category = svg.append("text")
    .attr("class", "smallfont")
    .translate(width/2 - 4, height * 0.79)
    .attr("text-anchor", "end")

dom.subcategory = svg.append("text")
    .attr("class", "smallfont")
    .translate(width/2 + 4, height * 0.79)
    .attr("text-anchor", "start")

dom.tooltip = svg.append("text")
    .translate(width/2, height * 0.82)
    .attr("text-anchor", "middle")



var state = {slide: -1, frozen: false}
var FINAL_SLIDE = 99;
var FINAL_DATA_SLIDE;
var DATA;

var treemap = d3.treemap()
    .tile(d3.treemapSquarify.ratio(1))
    .size([800, 400])
    .padding(1.8);

var TRANSITION_DURATION = 1000;

document.onkeydown = function(e) {
    e = e || window.event;
    switch(e.which || e.keyCode) {
        case 37: // left
            if (state.frozen){ break; }
            if (state.slide === FINAL_SLIDE){ state.slide = FINAL_DATA_SLIDE; afterParticles.stop(); }
            else if (state.slide > -1){ state.slide -= 1 }
            if (state.slide === -1){ introParticles.start() }
            state.frozen = true;
            setTimeout(render, 0)

        break;

        case 38: // up
        break;

        case 32: // space, deliberate fall-through
        case 39: // right
            if (state.frozen){ break; }
            if (state.slide === FINAL_DATA_SLIDE){ state.slide = FINAL_SLIDE; afterParticles.start(); }
            else if (DATA !== undefined && state.slide !== FINAL_SLIDE){ state.slide += 1 }
            if (state.slide === 0){ introParticles.stop() }
            state.frozen = true;
            setTimeout(render, 0)
        break;

        case 40: // down
        break;

        default: return; // exit this handler for other keys
    }
    e.preventDefault(); // prevent the default action (scroll / move caret)
}

d3.json("processed_data.json", function(error, data){
    if (error) return console.error(error);

    DATA = data;
    FINAL_DATA_SLIDE = data.length - 1;
    render();
})


function clearTooltip(){
    dom.tooltip.text("");
    dom.category.text("");
    dom.subcategory.text("");
}

dom.tooltip.text("");
function render(){
    var leaves, title, speakers;

    if (state.slide == -1){
        clearTooltip();
        leaves = [];
        title = "The Wikipedia Language Gap";
        speakers = undefined;
    }else if (state.slide == FINAL_SLIDE){
        clearTooltip();
        leaves = [];
        title = "Afterword";
        speakers = undefined;
    }else{

        var datum = DATA[state.slide] || [];

        var node = d3.hierarchy(datum, function(d){
            return d.categories || d.subcategories || d.articles || null;
        })
            .count()
            .sort(function(a, b) { return b.height - a.height; })

        var root = treemap(node)
        root.children.forEach(function(category, i){
            category.children.forEach(function(subcategory){
                subcategory.children.forEach(function(article){
                    article.categoryIndex = i;
                })
            })
        })

        leaves = root.leaves();
        title = root.data.language.english_name;
        if (title !== "English"){
            title += " – ";
            title += root.data.language.native_name;
        }
        speakers = root.data.language.native_speakers;
    }

    dom.introtext.transition().duration(TRANSITION_DURATION)
        .style("opacity", state.slide === -1 ? 1 : 0)

    dom.aftertext.transition().duration(TRANSITION_DURATION)
        .style("opacity", state.slide === FINAL_SLIDE ? 1 : 0)

    dom.title.transition().delay(TRANSITION_DURATION/2)
        .text(title)
        .on("end", function(){ state.frozen = false; })

    dom.nspeakers.transition().delay(TRANSITION_DURATION/2)
        .text(speakers ? formatLargeNumber(speakers) + " native speakers" : "" );

    var sel = dom.treemap.selectAll(".treeRect")
        .data(leaves);

    var mouseoverDebounce = false;

    sel.exit()
        .transition().duration(TRANSITION_DURATION)
          .style("opacity", 0)
        .remove();
    sel.enter().append("rect")
        .attr("class", "treeRect")
        .style("opacity", 0)
      .merge(sel)
        .attr("x", function(d){ return d.x0 })
        .attr("width", function(d){ return d.x1 - d.x0 })
        .attr("y", function(d){ return d.y0 })
        .attr("height", function(d){ return d.y1 - d.y0 })
        .on("mouseenter", function(d){
            mouseoverDebounce = true;
            dom.category.text(d.parent.parent.data.name + ":")
            dom.subcategory.text(d.parent.data.name)
            var txt;
            if (state.slide === 0){ // English
                txt = d.data.title;
            }else{
                txt = d.data.title + " – " + d.data.native_title;
            }
            dom.tooltip.text(txt);
        })
        .on("mouseleave", function(d){
            mouseoverDebounce = false;
            setTimeout(function(){ if (!mouseoverDebounce){ clearTooltip(); }}, 500)
        })
        .on("click", function(d){
            window.open(d.data.link, '_blank')
        })
      .transition().duration(TRANSITION_DURATION)
        .style("opacity", 1)
        .style("fill", function(d){
            var c = d3.hsl(colors[d.categoryIndex]);
            c.l = d.data.quality/2;
            return c.toString();
        })
}


function formatLargeNumber(n){
    if (n > 1e9){
        return Math.round(n/1e9) + " billion";
    }
    if (n > 1e6){
        return Math.round(n/1e6) + " million";
    }
    if (n > 1e3){
        return Math.round(n/1e3) + " thousand";
    }
    return ""+n
}

function particleSystem(spec){
    var intense = spec.intense;
    var g = spec.g.style("opacity", 1);
    var density = intense ? 15000 : 30000;
    var n = Math.floor(width*height/density)
    var clock; // initialized to clock at last possible moment
    var running = spec.running || false;
    var particles = d3.range(n).map(function(){ return particle(g, intense) })

    var draw = function(){
        particles.forEach(function(p){ p.update(); p.draw(); })

        if (running){
            window.requestAnimationFrame(draw);
        }
    }

    draw.start = function(){
        g.transition().delay(TRANSITION_DURATION).duration(TRANSITION_DURATION)
            .style("opacity", 1);
        running = true;
        // there's probably a way to do this with d3.timer....
        window.requestAnimationFrame(draw);
    }

    draw.stop = function(dur){
        g.transition().duration(500)
            .style("opacity", 0)
            .on("end", function(){ running = false; });
    }

    if (running){
        draw.start();
    }else{
        g.style("opacity", 0);
    }
    return draw;

}

function particle(g, intense){
    var color, sideLen, quality, x, y, xvel;
    var elem = g.append("rect")

    function reroll(startAnywhere){
        color = colors[Math.floor(d3.randomUniform(0, colors.length)())];
        color = d3.hsl(color);
        sideLen = intense ? d3.randomNormal(25, 4) : d3.randomLogNormal(1.8, 1);
        sideLen = Math.max(4, sideLen());
        quality = intense ? d3.randomUniform(0.7, 1) : d3.randomUniform(0.1, 0.6);
        color.l = quality()/2;
        color = color.toString()
        y = d3.randomUniform(0, height)()
        x = startAnywhere ? d3.randomUniform(0, width)() : -sideLen;
        xvel = intense ? d3.randomUniform(1, 6)() : d3.randomUniform(0.3, 1)();

        elem.attr("y", y)
            .attr("width", sideLen)
            .attr("height", sideLen)
            .style("fill", color)
    }
    reroll(true);

    return {
        update: function(){
            x += xvel;
            if (x > width){
                reroll();
            }
        },
        draw: function(){
            elem.attr("x", x)
        }
    }
}
    </script>
</body>
